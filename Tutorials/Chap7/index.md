# 7章 : 音を鳴らしてみよう

前章では、当たり判定を実装しました。  
この章では、ゲームに不可欠な音を追加します。  
ゲームには、オブジェクトの動きに合わせたサウンドエフェクト(SE)やゲームの雰囲気を作り出すBGMが必要です。  
以下では、SEやBGMを再生する処理を実装します。

## SEを鳴らす

今回は、以下のSEを再生します。  

- プレイヤーのショット音
- プレイヤーの死亡時サウンド
- 敵共通の死亡時サウンド
- まっすぐな弾を発射する敵のショット音
- 放射ショットの敵のショット音

### プレイヤーのショット音を追加

`Player.cs`に以下のソースコードを追加します。  

[!code-diff[Main](Spl1.cs)]

``` C#
// ショット時の効果音
private Sound shotSound;
```

Altseed2では、音源データを`Sound`クラスインスタンスに格納します。  
また、ファイルから音源データを読み込む場合は、以下のように`Sound.LoadStrict`メソッドを用います。

``` C#
// ショット音を読み込む
shotSound = Sound.LoadStrict("Resources/shot1.wav", true);
```

第一引数には、音源データファイルへのパスします。  
そして、第二引数には、音源データを事前に解凍するか否かを指定します。  
一般的に、短い音をたくさん鳴らすようなSEの場合は、事前に解凍します。  
一方、BGMのような長い音源に対しては、事前に解凍せず、逐次解凍するようにします。  

そして、読み込んだ音源データを再生するには、以下のように`Engine.Sound.Play`メソッドを呼び出す必要があります。

``` C#
// ショット音を鳴らす
Engine.Sound.Play(shotSound);
```

引数として、上で作成した`Sound`クラスインスタンスを渡します。  
  

この段階でビルドし、実行するとZキーでショットを放った瞬間に音が鳴ると思います。

### プレイヤーの死亡時サウンドを追加

ショット音と同様に`Player.cs`に以下のソースコードを追加します。

[!code-diff[Main](Spl2.cs)]

### 敵共通の死亡時サウンドを追加

すべての敵共通で再生するため、`Enemy.cs`に以下のソースコードを追加します。

[!code-diff[Main](Spl3.cs)]

### まっすぐな弾を発射する敵のショット音を追加

`StraightShotEnemy.cs`に以下のソースコードを追加します。

[!code-diff[Main](Spl4.cs)]

### 放射ショットの敵のショット音を追加

`RadialShotEnemy.cs`に以下のソースコードを追加します。

[!code-diff[Main](Spl5.cs)]

以上を追加し、ビルドするとSEが適切なタイミングで再生されると思います。

## BGMを鳴らす

次は、BGMを再生する処理を追加しましょう。  

メインステージのBGMであるため、`MainNode.cs`に以下のソースコードを追加します。

[!code-diff[Main](Spl6.cs)]

BGMに関する初期化をするメソッド`InitBGM`を実装し、
メインステージが始まった時点で再生するため、`OnAdded`で呼び出します。  

BGMを再生する場合も、基本的はSEと変わらず、`Sound`クラスインスタンスを用います。  
しかし、このままではうまくいきません。  
今回、BGMを再生するために、以下の処理が必要となります。

- ループ処理
- 再生している音の制御(一時停止、終了)

### ループ処理

`InitBGM`メソッドに以下の処理を追加しましょう。

[!code-diff[Main](Spl7.cs)]

BGMをループさせるには、`Sound`クラスインスタンスの`IsLoopingMode`プロパティを`true`にします。  
そして、音源の任意の区間をループさせる場合、

- `Sound`クラスインスタンスの`LoopStartingPoint`プロパティで区間の始点
- `Sound`クラスインスタンスの`LoopEndPoint`プロパティで区間の終点

を指定する必要があります。

### 再生している音の制御(一時停止、終了)

`MainNode.cs`に以下のソースコードを変更します。

[!code-diff[Main](Spl8.cs)]

再生している音は、`Engine.Sound.Play`メソッドの戻り値である`int`型のIDによって、制御できます。  
今回は、BGMはずっと再生させておくため、制御はしませんが、
今後、BGMを制御する場合に備えて、`MainNode`クラスの`bgmID`フィールドに格納しておきましょう。  
  
以上を反映させて、ビルドを行うとBGMが再生されると思います。

## まとめ

本章では、ゲームに音を加えることによって、よりゲームらしくなったかと思います。  
みなさんのゲームでも、どんどん効果音をつけていってください。  
  
次の章では、ゲーム性を高める上で重要な得点を表示させていきましょう。